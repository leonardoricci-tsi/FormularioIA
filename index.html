<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pesquisa: IA e Processos Cognitivos (An√¥nima)</title>
  <meta name="description" content="Formul√°rio an√¥nimo sobre impactos da IA nos processos cognitivos de jovens acad√™micos." />
  <style>
    :root {
      --bg: #0b0f15;       /* fundo escuro elegante */
      --card: #121826;     /* cart√£o */
      --muted: #9aa4b2;    /* texto secund√°rio */
      --text: #e6edf3;     /* texto principal */
      --brand: #4f46e5;    /* destaque */
      --ok: #16a34a;       /* sucesso */
      --warn: #d97706;     /* alerta */
      --err: #ef4444;      /* erro */
      --border: #1f2a3a;   /* bordas sutis */
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius-xl: 20px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: radial-gradient(1200px 1200px at 10% 0%, #151d2c 0%, var(--bg) 60%); color: var(--text); }

    .container { max-width: 900px; margin: clamp(16px, 5vw, 48px) auto; padding: 0 16px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)); border: 1px solid var(--border); border-radius: var(--radius-xl); box-shadow: var(--shadow); padding: clamp(16px, 3.2vw, 32px); }
    h1 { font-size: clamp(1.4rem, 2.4vw + .6rem, 2.2rem); margin: 0 0 8px; letter-spacing: 0.2px; }
    p.lead { color: var(--muted); margin-top: 0; margin-bottom: 24px; }

    .badge { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 999px; background: rgba(79,70,229,.15); color: #c7d2fe; border: 1px solid rgba(79,70,229,.35); font-weight: 600; font-size: .85rem; margin-bottom: 8px; }

    form { display: grid; gap: 22px; counter-reset: section; }
    fieldset {
      border: 1px dashed var(--border);
      border-radius: 16px;
      padding: 22px;
      background: linear-gradient(180deg, rgba(20,24,36,.85), rgba(10,14,22,.85));
      transition: border .2s ease, box-shadow .2s ease;
    }
    fieldset:hover { border-color: rgba(79,70,229,.45); box-shadow: 0 4px 18px rgba(79,70,229,.12); }
    fieldset:focus-within { border-color: rgba(99,102,241,.6); box-shadow: 0 6px 22px rgba(79,70,229,.18); }
    legend { display: inline-flex; align-items: center; gap: 12px; padding: 0 8px; color: #e2e8f5; font-weight: 700; letter-spacing: .2px; text-transform: uppercase; font-size: .82rem; }
    legend::before { counter-increment: section; content: counter(section); display: grid; place-items: center; width: 28px; height: 28px; border-radius: 50%; background: rgba(79,70,229,.2); border: 1px solid rgba(79,70,229,.5); color: #c7d2fe; font-size: .9rem; font-weight: 600; }
    .legend-sub { display: block; font-size: .75rem; font-weight: 500; letter-spacing: normal; color: var(--muted); text-transform: none; margin-left: 40px; margin-top: 6px; }

    .form-steps { display: flex; gap: 10px; list-style: none; padding: 0; margin: 0 0 12px; }
    .form-steps li { flex: 1; background: rgba(255,255,255,.04); border: 1px solid rgba(79,70,229,.25); border-radius: 999px; padding: 10px 14px; font-size: .78rem; font-weight: 600; color: #cbd5f5; display: flex; align-items: center; gap: 10px; justify-content: center; text-align: center; }
    .form-steps li::before { content: attr(data-step); display: inline-flex; align-items: center; justify-content: center; width: 26px; height: 26px; border-radius: 50%; background: rgba(79,70,229,.35); color: white; font-size: .75rem; font-weight: 700; }
    @media (max-width: 600px) { .form-steps { flex-direction: column; } }

    .grid { display: grid; gap: 18px; }
    @media (min-width: 720px) { .grid-2 { grid-template-columns: 1fr 1fr; } }

    .input-group { display: flex; flex-direction: column; gap: 6px; }
    label { display: block; font-weight: 600; }
    .hint { color: var(--muted); font-size: .92rem; margin-top: 6px; }

    input[type="text"], input[type="number"], textarea {
      width: 100%; background: #0f1623; color: var(--text); border: 1px solid var(--border); border-radius: 12px; padding: 12px 14px; outline: none; transition: border .2s, box-shadow .2s, background .2s;
    }
    textarea { min-height: 110px; resize: vertical; }
    input:focus, textarea:focus { border-color: rgba(79,70,229,.7); box-shadow: 0 0 0 4px rgba(79,70,229,.15); }
    select:invalid { color: rgba(156,163,175,.9); }

    .select-wrapper {
      position: relative;
      background: linear-gradient(180deg, rgba(20,29,43,.95), rgba(12,18,28,.95));
      border: 1px solid rgba(79,70,229,.3);
      border-radius: 12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
      transition: border .2s ease, box-shadow .2s ease;
    }
    .select-wrapper:hover { border-color: rgba(99,102,241,.45); box-shadow: 0 4px 16px rgba(79,70,229,.14), inset 0 1px 0 rgba(255,255,255,.08); }
    .select-wrapper:focus-within { border-color: rgba(99,102,241,.7); box-shadow: 0 0 0 4px rgba(79,70,229,.18), inset 0 1px 0 rgba(255,255,255,.08); }
    .select-wrapper select {
      width: 100%;
      display: block;
      border: none;
      background: transparent;
      padding: 14px 48px 14px 16px;
      font-size: 1rem;
      color: inherit;
      box-shadow: none;
      appearance: none;
      -webkit-appearance: none;
      cursor: pointer;
      outline: none;
    }
    .select-wrapper select:focus { box-shadow: none; }
    .select-wrapper::after {
      content: "";
      position: absolute;
      top: 50%;
      right: 18px;
      width: 12px;
      height: 12px;
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 12 12' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M2.25 4.5L6 8.25 9.75 4.5' fill='none' stroke='%23D7DCFF' stroke-width='1.6' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: center;
      background-size: 100%;
      transform: translateY(-50%);
      pointer-events: none;
      opacity: .9;
    }

    .options { display: grid; gap: 8px; }
    .inline { display: flex; flex-wrap: wrap; gap: 12px 20px; }
    .chip { display: inline-flex; gap: 10px; align-items: center; }
    .chip input { accent-color: var(--brand); }

    .required { color: #fca5a5; margin-left: 4px; }

    .btns { display: flex; gap: 12px; flex-wrap: wrap; }
    button {
      border: 1px solid transparent; border-radius: 14px; padding: 12px 18px; font-weight: 700; cursor: pointer; transition: transform .08s ease, box-shadow .2s ease, background .2s ease; will-change: transform;
    }
    .primary { background: linear-gradient(180deg, #6366f1, #4f46e5); color: white; box-shadow: 0 8px 22px rgba(79,70,229,.35); }
    .primary:hover { transform: translateY(-1px); }
    .ghost { background: transparent; color: #cbd5e1; border-color: var(--border); }
    button:focus-visible { outline: 2px solid rgba(99,102,241,.7); outline-offset: 3px; }

    .consent { background: rgba(20, 83, 45, .15); border: 1px solid rgba(34, 197, 94, .25); padding: 14px; border-radius: 12px; }

    .footer { color: var(--muted); font-size: .9rem; margin-top: 14px; }

    .success { display: none; padding: 26px; border: 1px solid rgba(22,163,74,.25); background: rgba(22,163,74,.12); border-radius: 16px; }
    .success h2 { margin: 0 0 6px; }

    .error { display: none; padding: 16px; border: 1px solid rgba(239,68,68,.35); background: rgba(239,68,68,.08); border-radius: 14px; }

    .visually-hidden { position: absolute !important; height: 1px; width: 1px; overflow: hidden; clip: rect(1px, 1px, 1px, 1px); white-space: nowrap; }
  </style>
</head>
<body>
  <main class="container">
    <div class="card">
      <div class="badge" aria-hidden="true">Formul√°rio An√¥nimo</div>
      <h1>Pesquisa ‚Äî IA & Processos Cognitivos</h1>
      <p class="lead">Question√°rio <strong>an√¥nimo</strong> para avaliar efeitos do uso de IA na aprendizagem, mem√≥ria, aten√ß√£o e tomada de decis√£o de jovens acad√™micos. N√£o coletamos nome, e‚Äëmail ou identificadores pessoais.</p>

      <form id="survey" autocomplete="off" aria-describedby="privacy-note">
        <ol class="form-steps" aria-hidden="true">
          <li data-step="1">Perfil b√°sico</li>
          <li data-step="2">Uso de IA</li>
          <li data-step="3">Impactos percebidos</li>
          <li data-step="4">Riscos e estrat√©gias</li>
        </ol>
        <!-- Aviso de anonimato e consentimento -->
        <section class="consent" role="region" aria-label="Consentimento e anonimato">
          <p id="privacy-note" class="hint">üîí Este formul√°rio √© an√¥nimo. N√£o registre seu nome, e‚Äëmail, RA ou qualquer dado identific√°vel. O servidor de destino pode registrar dados t√©cnicos (por exemplo, IP) conforme configura√ß√£o do seu provedor. Use endpoints que <em>n√£o</em> gravem IP se desejar anonimizar totalmente.</p>
          <label class="inline chip" for="consent">
            <input id="consent" name="consent" type="checkbox" required>
            <span>Li e concordo em participar voluntariamente desta pesquisa.<span class="required" aria-hidden="true">*</span></span>
          </label>
        </section>

        <!-- Perfil m√≠nimo (an√¥nimo): faixas et√°rias e curso opcional -->
        <fieldset>
          <legend>Perfil Demogr√°fico (opcional)</legend>
          <p class="legend-sub">Compartilhe apenas se desejar; os dados s√£o analisados de forma agregada e sem identifica√ß√£o individual.</p>
          <div class="grid grid-2">
            <div class="input-group">
              <label for="ageRange">Faixa et√°ria atual</label>
              <div class="select-wrapper">
                <select id="ageRange" name="ageRange">
                  <option value="">Prefiro n√£o informar</option>
                  <option>18‚Äì19</option>
                  <option>20‚Äì21</option>
                  <option>22‚Äì23</option>
                  <option>24‚Äì25</option>
                  <option>26+</option>
                </select>
              </div>
              <p class="hint">Manter uma faixa et√°ria ampla evita identifica√ß√£o direta e sustenta a an√°lise estat√≠stica.</p>
            </div>
            <div class="input-group">
              <label for="semester">Per√≠odo/semestre atual (opcional)</label>
              <div class="select-wrapper">
                <select id="semester" name="semester">
                  <option value="">Prefiro n√£o informar</option>
                  <option>1¬∫</option>
                  <option>2¬∫</option>
                  <option>3¬∫</option>
                  <option>4¬∫</option>
                  <option>5¬∫+</option>
                </select>
              </div>
            </div>
          </div>
        </fieldset>

        <!-- Frequ√™ncia e contexto de uso -->
        <fieldset>
          <legend>Uso de IA</legend>
          <p class="legend-sub">Dimens√µes que caracterizam a intensidade e os cen√°rios de uso da IA na vida acad√™mica e pessoal.</p>
          <div class="grid grid-2">
            <div class="input-group">
              <label for="freq">Frequ√™ncia de uso de IA em atividades acad√™micas<span class="required" aria-hidden="true">*</span></label>
              <div class="select-wrapper">
                <select id="freq" name="freq" required>
                  <option value="">Selecione uma op√ß√£o‚Ä¶</option>
                  <option>Nunca</option>
                  <option>Raramente (menos de 1x/semana)</option>
                  <option>Algumas vezes por semana</option>
                  <option>Diariamente</option>
                  <option>V√°rias vezes ao dia</option>
                </select>
              </div>
            </div>
            <div class="input-group">
              <label>Em quais contextos voc√™ utiliza IA? (marque quantos forem pertinentes)</label>
              <div class="options">
                <label class="chip"><input type="checkbox" name="context" value="Estudos"> Estudos/pesquisa acad√™mica</label>
                <label class="chip"><input type="checkbox" name="context" value="Profissional"> Tarefas pessoais/profissionais</label>
                <label class="chip"><input type="checkbox" name="context" value="Lazer"> Lazer/entretenimento</label>
                <label class="chip"><input type="checkbox" name="context" value="Escrita"> Apoio √† escrita/textos</label>
                <label class="chip"><input type="checkbox" name="context" value="Outro"> Outro</label>
              </div>
            </div>
          </div>
        </fieldset>

        <!-- Impactos cognitivos (Likert) -->
        <fieldset>
          <legend>Percep√ß√£o de Impactos Cognitivos</legend>
          <p class="legend-sub">Avalie o quanto voc√™ concorda com cada afirma√ß√£o sobre efeitos cognitivos observados ao usar IA.</p>
          <div class="grid">
            <div class="input-group">
              <label for="compr">O uso de IA amplia minha compreens√£o de novos conte√∫dos.</label>
              <div class="select-wrapper">
                <select id="compr" name="compr">
                  <option value="">Selecione uma op√ß√£o‚Ä¶</option>
                  <option>Discordo totalmente</option>
                  <option>Discordo parcialmente</option>
                  <option>Nem concordo nem discordo</option>
                  <option>Concordo parcialmente</option>
                  <option>Concordo totalmente</option>
                </select>
              </div>
            </div>
            <div class="input-group">
              <label for="mem">Percebo melhora na minha reten√ß√£o e mem√≥ria quando utilizo IA como apoio.</label>
              <div class="select-wrapper">
                <select id="mem" name="mem">
                  <option value="">Selecione uma op√ß√£o‚Ä¶</option>
                  <option>Discordo totalmente</option>
                  <option>Discordo parcialmente</option>
                  <option>Nem concordo nem discordo</option>
                  <option>Concordo parcialmente</option>
                  <option>Concordo totalmente</option>
                </select>
              </div>
            </div>
            <div class="input-group">
              <label for="dec">A IA fortalece meu racioc√≠nio e tomada de decis√£o em tarefas acad√™micas.</label>
              <div class="select-wrapper">
                <select id="dec" name="dec">
                  <option value="">Selecione uma op√ß√£o‚Ä¶</option>
                  <option>Discordo totalmente</option>
                  <option>Discordo parcialmente</option>
                  <option>Nem concordo nem discordo</option>
                  <option>Concordo parcialmente</option>
                  <option>Concordo totalmente</option>
                </select>
              </div>
            </div>
            <div class="input-group">
              <label for="auto">A IA contribui para ampliar minha autonomia intelectual.</label>
              <div class="select-wrapper">
                <select id="auto" name="auto">
                  <option value="">Selecione uma op√ß√£o‚Ä¶</option>
                  <option>Discordo totalmente</option>
                  <option>Discordo parcialmente</option>
                  <option>Nem concordo nem discordo</option>
                  <option>Concordo parcialmente</option>
                  <option>Concordo totalmente</option>
                </select>
              </div>
            </div>
          </div>
        </fieldset>

        <!-- Riscos e desafios -->
        <fieldset>
          <legend>Riscos e Desafios</legend>
          <p class="legend-sub">Indique seu grau de concord√¢ncia com poss√≠veis riscos associados ao uso de IA.</p>
          <div class="grid">
            <div class="input-group">
              <label for="dep">Sinto depend√™ncia de solu√ß√µes de IA para concluir atividades acad√™micas.</label>
              <div class="select-wrapper">
                <select id="dep" name="dep">
                  <option value="">Selecione uma op√ß√£o‚Ä¶</option>
                  <option>Discordo totalmente</option>
                  <option>Discordo parcialmente</option>
                  <option>Nem concordo nem discordo</option>
                  <option>Concordo parcialmente</option>
                  <option>Concordo totalmente</option>
                </select>
              </div>
            </div>
            <div class="input-group">
              <label for="aten">O uso prolongado de IA diminui minha aten√ß√£o e foco.</label>
              <div class="select-wrapper">
                <select id="aten" name="aten">
                  <option value="">Selecione uma op√ß√£o‚Ä¶</option>
                  <option>Discordo totalmente</option>
                  <option>Discordo parcialmente</option>
                  <option>Nem concordo nem discordo</option>
                  <option>Concordo parcialmente</option>
                  <option>Concordo totalmente</option>
                </select>
              </div>
            </div>
            <div class="input-group">
              <label for="risco">Qual √©, na sua avalia√ß√£o, o principal risco associado ao uso excessivo de IA?</label>
              <div class="select-wrapper">
                <select id="risco" name="risco">
                  <option value="">Selecione a alternativa que melhor representa sua percep√ß√£o‚Ä¶</option>
                  <option>Depend√™ncia tecnol√≥gica elevada</option>
                  <option>Redu√ß√£o do pensamento cr√≠tico</option>
                  <option>Menor reten√ß√£o de conte√∫do</option>
                  <option>Desigualdade de acesso √†s ferramentas</option>
                  <option>N√£o identifico riscos relevantes</option>
                  <option>Outro</option>
                </select>
              </div>
            </div>
          </div>
        </fieldset>

        <!-- Estrat√©gias e senso cr√≠tico -->
        <fieldset>
          <legend>Estrat√©gias e Senso Cr√≠tico</legend>
          <p class="legend-sub">Identifique estrat√©gias adotadas e a percep√ß√£o geral sobre o papel da IA no processo de aprendizagem.</p>
          <div class="grid">
            <div class="input-group">
              <label for="equilibrio">Voc√™ adota estrat√©gias estruturadas para equilibrar IA e estudo aut√¥nomo?</label>
              <div class="select-wrapper">
                <select id="equilibrio" name="equilibrio">
                  <option value="">Selecione uma op√ß√£o‚Ä¶</option>
                  <option>Sim, de forma consistente</option>
                  <option>Sim, em situa√ß√µes espec√≠ficas</option>
                  <option>Estou desenvolvendo estrat√©gias</option>
                  <option>Ainda n√£o adoto estrat√©gias estruturadas</option>
                </select>
              </div>
            </div>
            <div class="input-group">
              <label for="percepcao">Na sua percep√ß√£o geral, a IA representa‚Ä¶</label>
              <div class="select-wrapper">
                <select id="percepcao" name="percepcao">
                  <option value="">Selecione uma op√ß√£o‚Ä¶</option>
                  <option>Principalmente um apoio complementar ao aprendizado</option>
                  <option>Uma ferramenta que substitui parte do esfor√ßo cognitivo</option>
                  <option>Um risco direto √† autonomia cognitiva</option>
                  <option>Outro posicionamento</option>
                </select>
              </div>
            </div>
          </div>
        </fieldset>

        <div class="btns">
          <button type="submit" class="primary">Enviar respostas</button>
          <button type="reset" class="ghost">Limpar</button>
        </div>

        <div id="errorBox" class="error" role="alert">Ocorreu um erro ao enviar. Tente novamente.</div>
        <div id="successBox" class="success" role="status">
          <h2>‚úÖ Resposta registrada!</h2>
          <p>Obrigado por participar. Voc√™ pode fechar esta p√°gina com seguran√ßa.</p>
        </div>
        <p class="footer">D√∫vidas sobre anonimato? Remova campos opcionais e direcione o envio para um endpoint sem logs de IP. Ex.: webhook pr√≥prio ou fun√ß√£o Edge que descarta metadados.</p>
      </form>
    </div>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    // ===== Configura√ß√£o do envio =====
    // Op√ß√£o A: Preencha SUPABASE_URL/KEY para gravar direto na tabela "respostas_ia"
    //    create table respostas_ia (
    //      id bigint generated always as identity primary key,
    //      payload jsonb not null,
    //      csv_line text,
    //      created_at timestamp with time zone default timezone('utc', now())
    //    );
    //    Habilite RLS com pol√≠tica de insert via anon quando aplic√°vel.
    // Op√ß√£o B: Use ENDPOINT_URL para encaminhar via requisi√ß√£o POST (Edge Function, webhook, etc.).

    const SUPABASE_URL = "https://pgipqiardziraldqfqsc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBnaXBxaWFyZHppcmFsZHFmcXNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyOTUwMjAsImV4cCI6MjA3Nzg3MTAyMH0.9JcFA7W6Ge2karQTBDDCTcPQnspI4qb2NIFo0agyJ-c";
    const SUPABASE_TABLE = "respostas_ia";
    const ENDPOINT_URL = "";      // exemplo: https://<PROJECT>.functions.supabase.co/coletar-form

    const supabase = (SUPABASE_URL && SUPABASE_ANON_KEY)
      ? createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } })
      : null;

    const form = document.getElementById('survey');
    const successBox = document.getElementById('successBox');
    const errorBox = document.getElementById('errorBox');

    const CSV_FIELD_ORDER = [
      'ageRange',
      'semester',
      'freq',
      'context',
      'compr',
      'mem',
      'dec',
      'auto',
      'dep',
      'aten',
      'risco',
      'equilibrio',
      'percepcao'
    ];

    const CSV_HEADERS = [
      'faixa_etaria',
      'semestre',
      'frequencia_uso',
      'contextos_uso',
      'impacto_compreensao',
      'impacto_memoria',
      'impacto_decisao',
      'impacto_autonomia',
      'risco_dependencia',
      'risco_atencao',
      'principal_risco',
      'estrategias_equilibrio',
      'percepcao_geral'
    ];

    function formDataToJson(fd) {
      const data = {};
      // coleta m√∫ltiplos checkboxes com o mesmo nome em array
      for (const [key, value] of fd.entries()) {
        if (key === 'context') {
          if (!data[key]) data[key] = [];
          data[key].push(value);
        } else if (key === 'consent') {
          data[key] = true;
        } else {
          if (typeof value === 'string') {
            const trimmed = value.trim();
            data[key] = trimmed;
          } else {
            data[key] = value;
          }
        }
      }
      return data;
    }

    function toCsvLine(data) {
      const row = CSV_FIELD_ORDER.map((field) => {
        const value = data[field];
        if (Array.isArray(value)) {
          return value.length ? value.join('; ') : '';
        }
        if (value === undefined || value === null) return '';
        return String(value);
      });
      return row.map(escapeCsvValue).join(',');
    }

    function escapeCsvValue(value) {
      if (value === '') return '';
      const needsQuotes = value.includes(',') || value.includes('"') || value.includes('\n');
      const sanitized = value.replace(/"/g, '""');
      return needsQuotes ? `"${sanitized}"` : sanitized;
    }

    function triggerCsvDownload(csvLine) {
      const csvContent = [CSV_HEADERS.join(','), csvLine].join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `resposta-ia-${new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-')}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorBox.style.display = 'none';
      successBox.style.display = 'none';

      // Bloqueio simples contra campos identific√°veis
      const forbidden = ['nome', 'email', 'ra'];
      const hasForbidden = forbidden.some((id) => {
        const el = form.querySelector(`[name="${id}"]`);
        return el && el.value && el.value.trim().length > 0;
      });
      if (hasForbidden) {
        errorBox.textContent = 'Por favor, n√£o informe nome, e‚Äëmail ou RA.';
        errorBox.style.display = 'block';
        return;
      }

      const payload = formDataToJson(new FormData(form));
      const csvLine = toCsvLine(payload);

      try {
        if (supabase) {
          const insertPayload = { payload, csv_line: csvLine };
          const { error } = await supabase.from(SUPABASE_TABLE).insert(insertPayload);
          if (error) {
            const detailed = error.details || error.hint || error.message;
            throw new Error(detailed || 'Falha no envio');
          }
        } else if (ENDPOINT_URL) {
          const res = await fetch(ENDPOINT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ payload })
          });
          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || 'Falha no envio');
          }
        } else {
          // Sem integra√ß√£o configurada: modo offline
          successBox.style.display = 'block';
          triggerCsvDownload(csvLine);
          form.reset();
          return;
        }

        successBox.style.display = 'block';
        form.reset();
      } catch (err) {
        console.error(err);
        errorBox.textContent = err?.message
          ? `Erro no envio: ${err.message}`
          : 'Ocorreu um erro ao enviar. Tente novamente.';
        errorBox.style.display = 'block';
      }
    });
  </script>
</body>
</html>
